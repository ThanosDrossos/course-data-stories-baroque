<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Local test - Buildings Map</title>
  <link rel="stylesheet" href="../vendor/lib/leaflet/leaflet.css" />
  <style>body{font-family: Arial, sans-serif;margin:0;padding:0}#map{height:90vh;width:100%}</style>
</head>
<body>
  <h3 style="margin:8px">Local test: Buildings Map</h3>
  <div id="map"></div>

  <script src="../vendor/lib/leaflet/leaflet.js"></script>
  <script src="./baroque-viz.js"></script>
  <script>
    // Minimal mock BaroqueDB to simulate PRAGMA responses and query results
    window.BaroqueDB = {
      isReady: () => true,
      query: async function(sql) {
        sql = (sql||'').trim();
        console.log('MOCK BaroqueDB.query:', sql.split('\n')[0]);
        if (sql.startsWith("PRAGMA table_info('buildings')")) {
          return [
            {name: 'building_id'},
            {name: 'name'},
            {name: 'function'},
            {name: 'location_state'},
            {name: 'construction_date'},
            {name: 'ensemble_id'}
          ];
        }
        if (sql.startsWith("PRAGMA table_info('paintings')")) {
          return [
            {name:'nfdi_uri'}, {name:'cbdd_id'}, {name:'room_id'}, {name:'building_id'}, {name:'label'}, {name:'year'}, {name:'lat'}, {name:'lon'}, {name:'building_name'}, {name:'location_state'}
          ];
        }
        // Otherwise return sample aggregated building rows
        return [
          {building_name: 'St. Example Church', latitude: '48.1351', longitude: '11.5820', location_city: 'Munich', location_state: 'Bayern', painting_count: 5},
          {building_name: 'Example Palace', latitude: '49.0139', longitude: '8.4044', location_city: 'Karlsruhe', location_state: 'Baden-WÃ¼rttemberg', painting_count: 3}
        ];
      }
    };

    // Run the map render when page loads
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await BaroqueViz.renderBuildingsMap('#map');
        console.log('renderBuildingsMap completed');
      } catch (err) {
        console.error('renderBuildingsMap error:', err);
        document.body.insertAdjacentHTML('beforeend', '<pre style="color:red">'+err.stack+'</pre>');
      }
    });
  </script>
</body>
</html>
